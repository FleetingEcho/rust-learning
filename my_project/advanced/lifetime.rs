/*
Rust çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ ç¼–è¯‘å™¨ç”¨æ¥æ£€æŸ¥å¼•ç”¨æœ‰æ•ˆæ€§ çš„è§„åˆ™ï¼Œé˜²æ­¢æ‚¬å‚å¼•ç”¨ï¼ˆæŒ‡å‘æ— æ•ˆæ•°æ®ï¼‰ã€‚ç”Ÿå‘½å‘¨æœŸä¸€èˆ¬ç”± 'aã€'b è¿™æ ·çš„æ ‡æ³¨è¡¨ç¤ºã€‚


1. ä¸ºä»€ä¹ˆéœ€è¦ç”Ÿå‘½å‘¨æœŸï¼Ÿ
Rust é‡‡ç”¨ æ‰€æœ‰æƒ + å€Ÿç”¨ + ç”Ÿå‘½å‘¨æœŸ æ¥ç®¡ç†å†…å­˜ï¼Œä¸éœ€è¦åƒåœ¾å›æ”¶ã€‚ä½†æ˜¯ï¼š

å¯å˜å¼•ç”¨ &mut T ä¸èƒ½ä¸å…¶ä»–å¼•ç”¨å…±å­˜ã€‚
ç”Ÿå‘½å‘¨æœŸç¡®ä¿å¼•ç”¨çš„ä½œç”¨åŸŸæ˜¯å®‰å…¨çš„ï¼Œé˜²æ­¢æ‚¬å‚å¼•ç”¨ã€‚

2. ç”Ÿå‘½å‘¨æœŸåŸºæœ¬è§„åˆ™
Rust ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨æ¨å¯¼ç”Ÿå‘½å‘¨æœŸï¼Œä½†åœ¨æŸäº›å¤æ‚æƒ…å†µéœ€è¦æ‰‹åŠ¨æ ‡æ³¨ï¼š

æ‰€æœ‰å¼•ç”¨å¿…é¡»åœ¨æœ‰æ•ˆä½œç”¨åŸŸå†…ã€‚
å¯å˜å€Ÿç”¨ &mut T ä¸èƒ½ä¸ä¸å¯å˜å€Ÿç”¨ &T å…±å­˜ã€‚
å¤šä¸ªä¸å¯å˜å€Ÿç”¨æ˜¯å…è®¸çš„ã€‚
ç”Ÿå‘½å‘¨æœŸå‚æ•°ä¸ä¼šæ”¹å˜å®é™…çš„ç”Ÿå‘½å‘¨æœŸï¼Œåªæ˜¯å‘Šè¯‰ç¼–è¯‘å™¨ä¸åŒå¼•ç”¨çš„å…³ç³»ã€‚
*/

fn longest<'a>(s1: &'a str, s2: &'a str) -> &'a str {
    if s1.len() > s2.len() { s1 } else { s2 }
}
//è¿™é‡Œçš„ 'a è¡¨ç¤º s1 å’Œ s2 çš„ç”Ÿå‘½å‘¨æœŸç›¸åŒï¼Œè¿”å›å€¼çš„ç”Ÿå‘½å‘¨æœŸå¿…é¡»ä¸çŸ­äºå‚æ•°çš„ç”Ÿå‘½å‘¨æœŸã€‚



/*
4. ç”Ÿå‘½å‘¨æœŸå¸¸è§é—®é¢˜

é—®é¢˜ 1ï¼šç¼–è¯‘å™¨â€œå¤ªç¬¨â€

#[derive(Debug)]
struct Foo;
impl Foo {
    fn mutate_and_share(&mut self) -> &Self { &*self }
    fn share(&self) {}
}
fn main() {
    let mut foo = Foo;
    let loan = foo.mutate_and_share();
    foo.share(); // âŒ ç¼–è¯‘é”™è¯¯
    println!("{:?}", loan);
}
åŸå› ï¼šmutate_and_share() è¿”å›ä¸å¯å˜å¼•ç”¨ï¼Œä½†å®ƒçš„ &mut self å€Ÿç”¨ä»ç„¶æœ‰æ•ˆï¼ŒRust è®¤ä¸º foo è¿˜è¢«å¯å˜å€Ÿç”¨ï¼Œå¯¼è‡´ foo.share() å‡ºé”™ã€‚


è§£å†³ï¼šæ‰‹åŠ¨åˆ†ç¦»ä½œç”¨åŸŸï¼Œç¼©å° loan çš„ç”Ÿå‘½å‘¨æœŸï¼š
fn main() {
    let mut foo = Foo;
    {
        let loan = foo.mutate_and_share();
        println!("{:?}", loan);
    }
    foo.share(); // âœ… ç°åœ¨å¯ä»¥äº†
}



*/

/*
5. æ— ç•Œç”Ÿå‘½å‘¨æœŸ
å¦‚æœä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ˜¯ä»è£¸æŒ‡é’ˆæ¨å¯¼å‡ºæ¥çš„ï¼ŒRust æ— æ³•æ¨æ–­å®ƒçš„å®é™…ä½œç”¨åŸŸï¼Œå°±ä¼šå‡ºç°æ— ç•Œç”Ÿå‘½å‘¨æœŸï¼š
fn f<'a, T>(x: *const T) -> &'a T {
    unsafe { &*x } // âŒ 'a æ˜¯å‡­ç©ºäº§ç”Ÿçš„ï¼Œæ— ç•Œç”Ÿå‘½å‘¨æœŸ
}

é—®é¢˜ï¼šRust æ— æ³•ä¿è¯ x è¿™ä¸ªæŒ‡é’ˆçš„å€¼ä¸ä¼šåœ¨ 'a ç”Ÿå‘½å‘¨æœŸå†…å˜æˆæ— æ•ˆåœ°å€ã€‚
ğŸ”¹ è§£å†³ï¼šä½¿ç”¨ unsafe æ—¶è¦å°å¿ƒï¼Œç¡®ä¿ç”Ÿå‘½å‘¨æœŸç»‘å®šåˆ°æœ‰æ•ˆçš„å¼•ç”¨ä¸Šã€‚


6. ç”Ÿå‘½å‘¨æœŸçº¦æŸ
å¯ä»¥ç”¨ 'a: 'b çº¦æŸç”Ÿå‘½å‘¨æœŸçš„å¤§å°å…³ç³»ï¼š
struct DoubleRef<'a, 'b: 'a, T> {
    r: &'a T,
    s: &'b T,
}

'b: 'a ä»£è¡¨ 'b è‡³å°‘å’Œ 'a ä¸€æ ·é•¿ï¼Œæ„å‘³ç€ s æ´»å¾—æ¯” r ä¹…ã€‚


7. NLLï¼ˆéè¯æ³•ä½œç”¨åŸŸï¼‰
Rust 1.31+ å¼•å…¥äº† NLLï¼ˆNon-Lexical Lifetimeï¼‰ï¼Œè®©å€Ÿç”¨çš„ç”Ÿå‘½å‘¨æœŸåœ¨æœ€åä¸€æ¬¡ä½¿ç”¨åç«‹å³ç»“æŸ

fn main() {
    let mut s = String::from("hello");
    let r1 = &s;
    let r2 = &s;
    println!("{} and {}", r1, r2); // r1, r2 ç”Ÿå‘½å‘¨æœŸç»“æŸ

    let r3 = &mut s; // âœ… ç°åœ¨å¯ä»¥å€Ÿç”¨äº†ï¼
    println!("{}", r3);
}
ğŸ”¹ ä»¥å‰ï¼šr1, r2 ç”Ÿå‘½å‘¨æœŸä¼šæŒç»­åˆ° main ç»“æŸï¼Œå¯¼è‡´ r3 å€Ÿç”¨å¤±è´¥ã€‚
ğŸ”¹ ç°åœ¨ï¼šRust åªè®© r1, r2 æ´»åˆ° println! ç»“æŸï¼Œr3 å¯ä»¥å®‰å…¨å€Ÿç”¨ã€‚

*/


/*
8. Reborrowï¼ˆå†å€Ÿç”¨ï¼‰

#[derive(Debug)]
struct Point { x: i32, y: i32 }

fn main() {
    let mut p = Point { x: 0, y: 0 };
    let r = &mut p;
    let rr: &Point = &*r; // âœ… å…è®¸å†å€Ÿç”¨
    println!("{:?}", rr);

    r.x = 10; // âœ… è¿™é‡Œ `rr` å·²ç»è¢«é‡Šæ”¾ï¼Œå¯ä»¥ä¿®æ”¹ `r`
}

9. ç”Ÿå‘½å‘¨æœŸæ¶ˆé™¤è§„åˆ™
impl é‡Œçš„ç”Ÿå‘½å‘¨æœŸï¼š

impl<'a> Reader for BufReader<'a> {}
// å¯ä»¥ç”¨åŒ¿åç”Ÿå‘½å‘¨æœŸ '_ çœç•¥ï¼š

impl Reader for BufReader<'_> {}
ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨æ¨å¯¼ï¼ˆRust 2018+ï¼‰ï¼š

struct Ref<'a, T> { field: &'a T } // âœ… æ— éœ€ T: 'a
*/

//10. å¤æ‚ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹
struct Interface<'b, 'a: 'b> {
    manager: &'b mut Manager<'a>,
}

impl<'b, 'a: 'b> Interface<'b, 'a> {
    pub fn noop(self) { println!("interface consumed"); }
}

struct Manager<'a> { text: &'a str }

struct List<'a> { manager: Manager<'a> }

impl<'a> List<'a> {
    pub fn get_interface<'b>(&'b mut self) -> Interface<'b, 'a> where 'a: 'b {
        Interface { manager: &mut self.manager }
    }
}

fn main() {
    let mut list = List { manager: Manager { text: "hello" } };
    list.get_interface().noop();
    println!("Interface should be dropped here and the borrow released");

    use_list(&list); // âœ… ç°åœ¨å¯ä»¥å€Ÿç”¨äº†
}

fn use_list(list: &List) { println!("{}", list.manager.text); }
/*
ğŸ”¹ é—®é¢˜ï¼šå¦‚æœ get_interface ç”¨ 'a è€Œä¸æ˜¯ 'bï¼ŒRust è®¤ä¸º list åœ¨ main ç»“æŸå‰éƒ½åœ¨å¯å˜å€Ÿç”¨ï¼Œå¯¼è‡´ use_list(&list) æŠ¥é”™ã€‚
ğŸ”¹ è§£å†³ï¼šä½¿ç”¨ 'b è®© get_interface ç”Ÿå‘½å‘¨æœŸçŸ­äº List<'a>ï¼Œä¿è¯å¯å˜å€Ÿç”¨åœ¨ç”¨å®Œåé‡Šæ”¾ã€‚
*/

/*
æ€»ç»“
1. ç”Ÿå‘½å‘¨æœŸç”¨äºç¼–è¯‘å™¨æ£€æŸ¥å¼•ç”¨çš„æœ‰æ•ˆæ€§ï¼Œé˜²æ­¢æ‚¬å‚å¼•ç”¨ã€‚
2. Rust è‡ªåŠ¨æ¨å¯¼ç”Ÿå‘½å‘¨æœŸï¼Œä½†å¤æ‚æƒ…å†µä¸‹éœ€æ‰‹åŠ¨æ ‡æ³¨ã€‚
3. ç”Ÿå‘½å‘¨æœŸæ ‡æ³¨ <'a> è®©ä¸åŒå¼•ç”¨çš„ä½œç”¨åŸŸæ˜ç¡®ã€‚
4. NLL è®©ç”Ÿå‘½å‘¨æœŸæ›´åŠ æ™ºèƒ½ï¼Œé¿å…è¿‡æ—©æŠ¥é”™ã€‚
5. Reborrow å…è®¸å®‰å…¨åœ°å†å€Ÿç”¨ä½†ä¸èƒ½äº¤å‰ä½¿ç”¨ã€‚
6. é‡åˆ°ç”Ÿå‘½å‘¨æœŸé”™è¯¯ï¼Œå°è¯•ç¼©çŸ­ä½œç”¨åŸŸæˆ–è°ƒæ•´å‚æ•°é¡ºåºã€‚

*/


/*
ç®€å•æ¥è¯´ï¼Œ&'static å’Œ T: 'static ä¸»è¦çš„åŒºåˆ«åœ¨äº å®ƒä»¬ä½œç”¨çš„å¯¹è±¡ä¸åŒï¼š

1. &'static â€”â€” é€‚ç”¨äºå¼•ç”¨
&'static ä»£è¡¨ å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸå¿…é¡»å’Œæ•´ä¸ªç¨‹åºä¸€æ ·é•¿ã€‚
é€‚ç”¨äºå­—ç¬¦ä¸²å­—é¢é‡ï¼ˆå› ä¸ºå®ƒä»¬å­˜å‚¨åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œç¨‹åºè¿è¡ŒæœŸé—´ä¸ä¼šè¢«é‡Šæ”¾ï¼‰ã€‚
å˜é‡æŒæœ‰ &'static å¼•ç”¨æ—¶ï¼Œå˜é‡æœ¬èº«çš„ç”Ÿå‘½å‘¨æœŸä¾ç„¶å—ä½œç”¨åŸŸé™åˆ¶ï¼Œä¸èƒ½æ··æ·†ã€‚
ç¤ºä¾‹ï¼š


fn print_author(author: &'static str) {
    println!("{}", author);
}

fn main() {
    let mark_twain: &str = "Samuel Clemens";  // è¿™ä¸ªå­—ç¬¦ä¸²å­—é¢é‡æ˜¯ 'static
    print_author(mark_twain);
}
è¿™é‡Œ mark_twain æŒæœ‰çš„æ˜¯ &'static strï¼Œä½† mark_twain æœ¬èº«çš„ä½œç”¨åŸŸè¿˜æ˜¯å— main å‡½æ•°æ§åˆ¶ã€‚
å˜é‡ä¸ä¼šå­˜æ´»æ•´ä¸ªç¨‹åºç”Ÿå‘½å‘¨æœŸï¼Œä½†å­—ç¬¦ä¸²æ•°æ®ä¼šã€‚


2. T: 'static â€”â€” é€‚ç”¨äºæ³›å‹ç±»å‹

T: 'static ä¸æ˜¯å¼•ç”¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ³›å‹ç”Ÿå‘½å‘¨æœŸçº¦æŸã€‚
è¡¨ç¤º T æœ¬èº«ï¼ˆè€Œä¸æ˜¯å¼•ç”¨ï¼‰å¿…é¡»å­˜æ´»æ•´ä¸ªç¨‹åºç”Ÿå‘½å‘¨æœŸã€‚
ä½†å¦‚æœ T åªæ˜¯è¢« &T è¿™ç§å¼•ç”¨ä½¿ç”¨ï¼ŒRust ç¼–è¯‘å™¨ä¸ä¼šä¸¥æ ¼æ£€æŸ¥ T çš„ç”Ÿå‘½å‘¨æœŸã€‚
ç¤ºä¾‹1ï¼ˆæŠ¥é”™æƒ…å†µï¼‰ï¼š


fn print_it<T: 'static>(input: T) {
    println!("{:?}", input);
}

fn main() {
    let i = 5;
    print_it(&i); // âŒ æŠ¥é”™ï¼Œå› ä¸º &i ä¸æ˜¯ 'static
}
i åªæ˜¯ main é‡Œçš„å±€éƒ¨å˜é‡ï¼Œå®ƒçš„å¼•ç”¨ &i ä¸èƒ½æ´»å¾—å’Œç¨‹åºä¸€æ ·ä¹…ï¼Œå› æ­¤æŠ¥é”™ã€‚


ç¤ºä¾‹2ï¼ˆä¸ä¼šæŠ¥é”™ï¼‰ï¼š
fn print_it<T: 'static>(input: &T) {
    println!("{:?}", input);
}

fn main() {
    let i = 5;
    print_it(&i);  // âœ… ä¸æŠ¥é”™ï¼Œå› ä¸ºè¿™é‡Œæ˜¯ `&T`ï¼Œç¼–è¯‘å™¨ä¸ä¼šä¸¥æ ¼æ£€æŸ¥ `T` çš„ç”Ÿå‘½å‘¨æœŸ
}

è¿™é‡Œ T åªæ˜¯è¢«å¼•ç”¨ &T çº¦æŸäº†ï¼Œè€Œ &T åªè¦ç¬¦åˆä½œç”¨åŸŸè§„åˆ™å³å¯ï¼Œä¸éœ€è¦ T æ˜¯ 'staticã€‚


3. é‡ç‚¹æ€»ç»“
åŒºåˆ«	          &'static	          T: 'static
é€‚ç”¨èŒƒå›´        	å¼•ç”¨                 	æ³›å‹ç±»å‹
è¦æ±‚	å¼•ç”¨å¿…é¡»æ´»å¾—å’Œç¨‹åºä¸€æ ·ä¹…	T ä¸èƒ½åŒ…å«é 'static æ•°æ®
ä½¿ç”¨åœºæ™¯	é€‚ç”¨äºå­—ç¬¦ä¸²å­—é¢é‡ã€å…¨å±€é™æ€å˜é‡ç­‰	æ³›å‹çº¦æŸï¼Œç¡®ä¿ T ä¸ä¾èµ–çŸ­ç”Ÿå‘½å‘¨æœŸæ•°æ®
å˜é‡ä½œç”¨åŸŸ	å˜é‡çš„ä½œç”¨åŸŸå—é™åˆ¶ï¼Œä½†å¼•ç”¨æŒ‡å‘çš„æ•°æ®å¯èƒ½æ˜¯ 'static	åªè¦ T æ˜¯ &Tï¼Œç¼–è¯‘å™¨ä¸ä¼šä¸¥æ ¼æ£€æŸ¥


4. æ€»ç»“ä¸€å¥è¯

&'static é€‚ç”¨äºå¼•ç”¨ï¼Œè¦æ±‚å¼•ç”¨çš„æ•°æ®å¿…é¡»æ´»å¾—å’Œç¨‹åºä¸€æ ·ä¹…ï¼Œä½†å˜é‡ä½œç”¨åŸŸä»å—é™åˆ¶ã€‚

T: 'static é€‚ç”¨äºæ³›å‹ç±»å‹ï¼Œä¿è¯ T æœ¬èº«ä¸ä¾èµ–çŸ­ç”Ÿå‘½å‘¨æœŸæ•°æ®ï¼Œä½†å¦‚æœ T åªæ˜¯ &Tï¼Œç¼–è¯‘å™¨ä¸ä¼šä¸¥æ ¼æ£€æŸ¥ T çš„ç”Ÿå‘½å‘¨æœŸã€‚

*/